---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
```{r setup}
library(knitr)

knitr::opts_knit$set(root.dir = "/Users/Julian/Documents/Jupyter/miRetrieve_pkg_files/miRetrieve_paper/")
```

```{r}
library(miRetrieve) # Load miRetrieve
library(magrittr) # Load magrittr for %>% 

# Set working directory with `setwd()` to folder containing 
# PubMed abstracts ("miRNA_atherosclerosis.txt", "miRNA_lungcancer.txt") and
# miRTarBase ("miRTarBase_MTI.xlsx"). miRTarBase can be downloaded from
# http://mirtarbase.mbc.nctu.edu.tw/php/download.php.

# Load abstracts ---------------------------------------------------------------

# MEDLINE file of abstracts matching "atherosclerosis miRNA"
file <- "miRNA_atherosclerosis.txt"

# Load abstracts
df_atherosclerosis <- read_pubmed_medline(file, topic = "Atherosclerosis") %>% 
    # Subset for original articles
    subset_research() %>%
    # Extract miRNA names mentioned at least twice/abstract
    extract_mir_df(threshold = 2)

# `df` summary -----------------------------------------------------------------

# Number of abstracts
length(unique(df_atherosclerosis[["PMID"]]))

# Number of rows
nrow(df_atherosclerosis)

# Top miRNAs in atherosclerosis ------------------------------------------------

# Plot top miRNAs
plot_mir_count(df_atherosclerosis,
               title = "Most frequently mentioned miRNAs in atherosclerosis")

save_plot("top_mirnas_atherosclerosis.pdf", width = 8, height = 6, dpi = 600)

# Term association of miR-155 and miR-21 in atherosclerosis --------------------

# Plot single word terms for miR-155
plot_mir_terms(df_atherosclerosis, "miR-155",
               title = "Top single terms for miR-155 in atherosclerosis")

save_plot("top_terms_155_atherosclerosis.pdf", width = 8, height = 6, dpi = 600)

# Plot 2-grams for miR-155
plot_mir_terms(df_atherosclerosis, "miR-155", token = "ngrams", n = 2,
               title = "Top 2-grams for miR-155 in atherosclerosis")

save_plot("top_2grams_155_atherosclerosis.pdf", width = 9, height = 6, dpi = 600)

# Plot single word terms for miR-21
plot_mir_terms(df_atherosclerosis, "miR-21",
               title = "Top single terms for miR-21 in atherosclerosis")

save_plot("top_terms_21_atherosclerosis.pdf", width = 8, height = 6, dpi = 600)

# Plot 2-grams for miR-21
plot_mir_terms(df_atherosclerosis, "miR-21", token = "ngrams", n = 2,
               title = "Top 2-grams for miR-21 in atherosclerosis")

save_plot("top_2grams_21_atherosclerosis.pdf", width = 9, height = 6, dpi = 600)

# miRNA-target interactions in atherosclerosis ---------------------------------

# Path to miRTarBase
target_db <- "miRTarBase_MTI.xlsx"

# Add miRTarBase targets to df
df_targets_ath <- join_targets(df_atherosclerosis,
                           excel_file = target_db,
                           col.pmid.excel = "References (PMID)",
                           col.target.excel = "Target Gene",
                           col.mir.excel = "miRNA",
                           stem_mir_excel = TRUE)

# Display targets of miR-155 and miR-21
plot_target_mir_scatter(df_targets_ath,
                        mir = c("miR-155", "miR-21"),
                        alpha = 1,
                        title = "Targets of miR-21 and miR-155 in atherosclerosis")

save_plot("targets_155_21_atherosclerosis.pdf", width = 8, height = 4, dpi = 600)

# Load abstracts lung cancer ------------------------------------------------------

# MEDLINE file of abstracts matching "lung cancer miRNA"
file_lc <- "miRNA_lungcancer.txt"

# Load abstracts
df_lc <- read_pubmed_medline(file_lc, topic = "Lung cancer") %>% 
    # Subset for original articles
    subset_research() %>%
    # Extract miRNA names mentioned at least twice/abstract
    extract_mir_df(threshold = 2)

# `df_lc` summary --------------------------------------------------------------

# Number of abstracts
length(unique(df_lc[["PMID"]]))

# Number of rows
nrow(df_lc)

# Top miRNAs in lung cancer ----------------------------------------------------

# Plot top miRNAs in lung cancer
plot_mir_count(df_lc,
               title = "Most frequently mentioned miRNAs in lung cancer")

save_plot("top_mirna_lungcancer.pdf", width = 8, height = 6, dpi = 600)

# Compare miR-21-term associations in atherosclerosis and lung cancer ----------

# Combine `df_atherosclerosis` und `df_lc`
df_athlc <- combine_df(df_atherosclerosis, df_lc)

# Compare terms miR-21 ---------------------------------------------------------

# Compare shared terms, single word
compare_mir_terms(df_athlc, "miR-21", top = 10,
                  title = "Comparison of miR-21 single term association")

save_plot("comparison_21_ath_lungcancer.pdf", width = 9, height = 7, dpi = 600)

# Compare shared terms, 2-gram
compare_mir_terms(df_athlc, "miR-21", token = "ngrams", n = 2,
                  title = "Comparison of miR-21 2-gram association")

save_plot("comparison_21_2gram_ath_lungcancer.pdf", width = 9, height = 7, dpi = 600)

# Compare terms miR-155 --------------------------------------------------------

# Compare shared terms, single word
compare_mir_terms(df_athlc, "miR-155", top = 10,
                  title = "Comparison of miR-155 single term association")

save_plot("comparison_155_ath_lungcancer.pdf", width = 9, height = 7, dpi = 600)

# Compare shared terms, 2-gram
compare_mir_terms(df_athlc, "miR-155", token = "ngrams", n = 2,
                  title = "Comparison of miR-155 2-gram association")

save_plot("comparison_155_2gram_ath_lungcancer.pdf", width = 9, height = 7, dpi = 600)

# Compare target interaction in atherosclerosis and lung cancer ----------------

# Join targets
df_targets_athlc <- join_targets(df_athlc,
                           excel_file = target_db,
                           col.pmid.excel = "References (PMID)",
                           col.target.excel = "Target Gene",
                           col.mir.excel = "miRNA",
                           stem_mir_excel = TRUE)

# Display targets
plot_target_mir_scatter(df_targets_athlc, mir = "miR-21", top = 10, alpha = 1,
                        title = "miR-21 targets in atherosclerosis and lung cancer")

save_plot("target_21_ath_lungcancer.pdf", width = 8, height = 3, dpi = 600)

plot_target_mir_scatter(df_targets_athlc, mir = "miR-155", top = 10, alpha = 1,
                        title = "miR-155 targets in atherosclerosis and lung cancer")

save_plot("target_155_ath_lungcancer.pdf", width = 8, height = 3, dpi = 600)
```

```{r}
library(topicmodels)
```

